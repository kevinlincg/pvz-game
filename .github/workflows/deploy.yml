name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pvz-game
        uses: actions/checkout@v4
        with:
          path: pvz-game

      - name: Checkout sf3-engine (private)
        uses: actions/checkout@v4
        with:
          repository: kevinlincg/soulfire3
          ssh-key: ${{ secrets.SF3_DEPLOY_KEY }}
          path: sf3-engine

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51

      - name: Build pvz-game (web)
        working-directory: pvz-game
        run: |
          emcmake cmake -B build-web -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DSF3_ENGINE_DIR=${{ github.workspace }}/sf3-engine \
            -DPVZ_SF3_SOURCE=ON
          cmake --build build-web -j$(nproc)

      - name: Prepare deploy directory
        working-directory: pvz-game
        run: |
          mkdir -p build-web/deploy
          cp build-web/plant-legends.html build-web/deploy/index.html
          cp build-web/plant-legends.js build-web/deploy/
          cp build-web/plant-legends.wasm build-web/deploy/
          cp build-web/plant-legends.data build-web/deploy/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy pvz-game/build-web/deploy --project-name=pvz-game
