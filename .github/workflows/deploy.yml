name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout pvz-game
        uses: actions/checkout@v4
        with:
          path: pvz-game

      - name: Checkout sf3-engine (private)
        uses: actions/checkout@v4
        with:
          repository: kevinlincg/soulfire3
          ssh-key: ${{ secrets.SF3_DEPLOY_KEY }}
          path: sf3-engine

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.51

      - name: Build sf3-engine (web)
        run: |
          cd sf3-engine
          echo "=== Building SF3 for Web ==="
          emcmake cmake -B build-web \
            -DCMAKE_BUILD_TYPE=Release \
            -DSF3_BUILD_EXAMPLES=OFF \
            -DSF3_BUILD_TESTS=OFF \
            -DSF3_ENABLE_NET=OFF \
            -DSF3_ENABLE_PACKAGE=OFF \
            -DSF3_ENABLE_SAVE=OFF \
            -DSF3_ENABLE_DIALOGUE=OFF \
            -DSF3_ENABLE_AI=OFF \
            -DSF3_ENABLE_THREADING=OFF \
            -DSDL_SHARED=OFF \
            -DSDL_STATIC=ON
          
          echo ""
          echo "=== Compiling SF3 ==="
          cmake --build build-web -j$(nproc) 2>&1 | tail -100
          
          echo ""
          echo "=== Checking SF3 build output ==="
          ls -lh build-web/libsf3.a || echo "ERROR: libsf3.a not found!"
          
          echo ""
          echo "=== ALL .a files in build-web (with size) ==="
          find build-web -name "*.a" -type f -exec ls -lh {} \;
          
          echo ""
          echo "=== Looking for Lua libraries ==="
          find build-web -name "*lua*.a" -type f -exec ls -lh {} \;
          
          echo ""
          echo "=== Directory structure of _deps ==="
          ls -la build-web/_deps/ 2>/dev/null || echo "No _deps directory"
          
          echo ""
          echo "=== Check for lua54 directory ==="
          ls -la build-web/_deps/lua54-* 2>/dev/null || echo "No lua54 directory"

      - name: Build pvz-game (web)
        run: |
          cd pvz-game
          echo "=== Checking SF3 paths ==="
          echo "SF3_ENGINE_DIR: ${{ github.workspace }}/sf3-engine"
          echo "SF3_BUILD_DIR: ${{ github.workspace }}/sf3-engine/build-web"
          echo "SF3_LIBRARY: ${{ github.workspace }}/sf3-engine/build-web/libsf3.a"
          ls -lh ${{ github.workspace }}/sf3-engine/build-web/libsf3.a || echo "ERROR: libsf3.a not found!"
          
          echo ""
          echo "=== Looking for Lua library ==="
          find ${{ github.workspace }}/sf3-engine/build-web -name "liblua*.a" -o -name "lua*.a" 2>/dev/null || echo "Lua lib not found in expected locations"
          
          echo ""
          echo "=== Checking SF3 build deps ==="
          ls -la ${{ github.workspace }}/sf3-engine/build-web/_deps/ 2>/dev/null || echo "No _deps directory"
          
          echo ""
          echo "=== Checking pvz-game directory ==="
          pwd
          ls -la
          
          emcmake cmake -B build-web -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DSF3_ENGINE_DIR=${{ github.workspace }}/sf3-engine \
            -DPVZ_SF3_SOURCE=OFF \
            -DSF3_BUILD_DIR=${{ github.workspace }}/sf3-engine/build-web \
            -DSF3_LIBRARY=${{ github.workspace }}/sf3-engine/build-web/libsf3.a
          cmake --build build-web -j$(nproc)

      - name: Prepare deploy directory
        run: |
          cd pvz-game
          mkdir -p build-web/deploy
          cp build-web/plant-legends.html build-web/deploy/index.html
          cp build-web/plant-legends.js build-web/deploy/
          cp build-web/plant-legends.wasm build-web/deploy/
          cp build-web/plant-legends.data build-web/deploy/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy pvz-game/build-web/deploy --project-name=pvz-game
